generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @unique @default(uuid())
  email         String?        @unique
  phone         String?        @unique
  password      String?
  organization  Organization?
  agent         Agent?
  verifications Verification[]
  sessions      Session[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Organization {
  id        String     @id @unique @default(uuid())
  name      String
  admin     User       @relation(fields: [adminId], references: [id])
  adminId   String     @unique
  stripe    Stripe     @relation(fields: [stripeId], references: [id])
  stripeId  String     @unique
  agents    Agent[]
  places    Place[]
  tasks     Task[]
  shipments Shipment[]
  vehicles  Vehicle[]
  plans     Plan[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Stripe {
  id           String        @id @unique @default(uuid())
  customerId   String        @unique
  organization Organization?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Verification {
  id        String   @id @unique @default(uuid())
  code      Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
}

model Session {
  id        String   @id @unique @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
}

model Agent {
  id             String       @id @unique @default(uuid())
  name           String
  user           User?        @relation(fields: [userId], references: [id])
  userId         String?      @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  location       Location?    @relation("AgentLocation", fields: [locationId], references: [id])
  locationId     String?      @unique
  locations      Location[]   @relation("AgentLocations")
  tasks          Task[]
  places         Place[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Location {
  id         String   @id @unique @default(uuid())
  position   Json
  currentFor Agent?   @relation("AgentLocation")
  agent      Agent    @relation("AgentLocations", fields: [agentId], references: [id])
  agentId    String
  createdAt  DateTime @default(now())
}

model Place {
  id             String       @id @unique @default(uuid())
  name           String
  phone          String?
  email          String?
  description    String
  lat            Float
  lng            Float
  agent          Agent?       @relation(fields: [agentId], references: [id])
  agentId        String?
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  stops          Stop[]
  shipments      Shipment[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  plans          Plan[]
}

model Task {
  id             String        @id @unique @default(uuid())
  versions       TaskVersion[]
  organization   Organization  @relation(fields: [organizationId], references: [id])
  organizationId String
  agent          Agent         @relation(fields: [agentId], references: [id])
  agentId        String
  plan           Plan?         @relation(fields: [planId], references: [id])
  planId         String?
  vehicle        Vehicle?      @relation(fields: [vehicleId], references: [id])
  vehicleId      String?
  startAt        DateTime
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Stop {
  id            String       @id @unique @default(uuid())
  taskVersionId String
  place         Place        @relation(fields: [placeId], references: [id])
  placeId       String
  order         Int
  note          String?
  arrivedAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  shipment      Shipment?
  taskVersion   TaskVersion @relation(fields: [taskVersionId], references: [id])
}

model Vehicle {
  id             String       @id @unique @default(uuid())
  name           String?
  capacities     Json?
  plans          Plan[]
  tasks          Task[]
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Shipment {
  id             String       @id @unique @default(uuid())
  size           Json?
  duration       Int?
  windows        Json
  plans          Plan[]
  place          Place        @relation(fields: [placeId], references: [id])
  placeId        String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  stop           Stop?        @relation(fields: [stopId], references: [id])
  stopId         String?      @unique
}

model Plan {
  id             String       @id @unique @default(uuid())
  startAt        DateTime
  endAt          DateTime
  breaks         Json?
  vehicles       Vehicle[]
  shipments      Shipment[]
  tasks          Task[]
  depot          Place?       @relation(fields: [depotId], references: [id])
  depotId        String?
  result         Json?
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model TaskVersion {
  id             String @id @unique @default(uuid())
  stops          Stop[]
  route          Json
  task           Task   @relation(fields: [taskId], references: [id])
  taskId         String
  createdAt      DateTime     @default(now())
  updateAt       DateTime     @updatedAt
}
